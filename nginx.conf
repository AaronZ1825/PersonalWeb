# ============================================================
# NGINX config for serving a single-page app (e.g., Vue/React)
# - Serves static assets from /usr/share/nginx/html
# - SPA history fallback to /index.html
# - Lightweight /healthz for container healthchecks
# - Static asset caching (tweak as needed)
# ============================================================

server {
  # [CHANGE ME] If you run behind a reverse proxy or need HTTPS,
  # you will likely have a separate 443 server block with TLS.
  listen 80;
  # [CHANGE ME] Replace "_" with your domain(s), e.g. example.com www.example.com
  server_name _;

  # Root of built assets (matches Dockerfile COPY destination)
  # [CHANGE ME] If your build output is different, update this path.
  root /usr/share/nginx/html;
  index index.html;

  # -------- Health endpoint (for Docker HEALTHCHECK) ----------
  # Simple 200 "ok" text response
  location = /healthz {
    return 200 'ok';
    add_header Content-Type text/plain;
    access_log off;
  }

  # -------- Main app: history API fallback --------------------
  # Try the exact file, then directory, else serve index.html (SPA)
  location / {
    try_files $uri $uri/ /index.html;
  }

  # -------- Static assets caching -----------------------------
  # Cache-bust via hashed filenames (recommended). If you don't use
  # hashed filenames, consider shorter 'expires' or add 'immutable' only
  # to hashed assets.
  location ~* \.(?:js|css|woff2?|ttf|otf|eot|gif|png|jpg|jpeg|svg)$ {
    expires 30d;             # [CHANGE ME] Shorten/lengthen to fit your release cadence
    add_header Cache-Control "public";  # [OPTIONAL] Add 'immutable' if using hashed filenames
    access_log off;
    try_files $uri =404;     # Hard 404 for missing assets (avoids index fallback here)
  }

  # -------- [OPTIONAL] Security headers -----------------------
  # Uncomment and tune for your app. Test thoroughly (CSP especially).
  # add_header X-Content-Type-Options nosniff;
  # add_header X-Frame-Options DENY;
  # add_header Referrer-Policy strict-origin-when-cross-origin;
  # add_header Permissions-Policy "geolocation=(), microphone=(), camera=()";
  # add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:";

  # -------- [OPTIONAL] Gzip compression -----------------------
  # Useful for text assets. (Many distros ship this in nginx.conf/http{}.)
  # gzip on;
  # gzip_types text/plain text/css application/javascript application/json application/xml+rss;
  # gzip_min_length 1024;

  # -------- [OPTIONAL] Error pages ----------------------------
  # error_page 404 /index.html; # SPA-friendly 404 (only if you want unknown paths to render app)
}
